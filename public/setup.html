<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MMM-StylishTodoist Setup</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #E84C3D;
      --primary-dark: #c0392b;
      --primary-light: #ff6b5b;
      --text: #2c3e50;
      --text-light: #7f8c8d;
      --light-bg: #f5f5f5;
      --border: #e0e0e0;
      --card-bg: #ffffff;
      --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      --success: #28a745;
      --error: #dc3545;
      --warning: #ffc107;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Roboto', sans-serif;
    }

    body {
      background-color: var(--light-bg);
      color: var(--text);
      line-height: 1.6;
      padding: 0;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      background: var(--card-bg);
      border-radius: 8px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    header {
      background-color: var(--primary);
      color: white;
      padding: 25px;
      text-align: center;
      position: relative;
    }

    header h1 {
      font-size: 2em;
      margin-bottom: 5px;
      font-weight: 500;
    }

    header p {
      opacity: 0.9;
      font-weight: 300;
    }

    .logo {
      position: absolute;
      top: 20px;
      left: 20px;
      font-size: 1.5em;
    }

    .tabs {
      display: flex;
      background: var(--primary-dark);
      position: relative;
    }

    .tab {
      padding: 15px 25px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
      color: rgba(255, 255, 255, 0.8);
      font-weight: 500;
      position: relative;
      flex: 1;
      z-index: 1;
    }

    .tab:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .tab.active {
      color: white;
    }

    .tab-indicator {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: white;
      transition: all 0.3s ease;
      z-index: 0;
    }

    .tab-badge {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      padding: 2px 8px;
      font-size: 0.8em;
      margin-left: 5px;
    }

    .tab-content {
      display: none;
      padding: 25px;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .tab-content.active {
      display: block;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-row {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
    }

    .form-col {
      flex: 1;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text);
    }

    label.inline {
      display: inline-flex;
      align-items: center;
      margin-right: 15px;
      cursor: pointer;
    }

    input[type="text"],
    input[type="password"],
    input[type="number"],
    input[type="color"],
    select,
    textarea {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 16px;
      transition: all 0.3s;
    }

    input[type="text"]:focus,
    input[type="password"]:focus,
    input[type="number"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(232, 76, 61, 0.2);
    }

    input[type="checkbox"],
    input[type="radio"] {
      margin-right: 8px;
    }

    .input-with-icon {
      position: relative;
    }

    .input-with-icon i {
      position: absolute;
      top: 50%;
      right: 15px;
      transform: translateY(-50%);
      color: var(--text-light);
      cursor: pointer;
    }

    .input-with-icon i:hover {
      color: var(--primary);
    }

    button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    button:hover {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
    }

    button i {
      margin-right: 8px;
    }

    button.secondary {
      background-color: white;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    button.secondary:hover {
      background-color: var(--light-bg);
    }

    button.danger {
      background-color: var(--error);
    }

    button.danger:hover {
      background-color: #c82333;
    }

    button.success {
      background-color: var(--success);
    }

    button.success:hover {
      background-color: #218838;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    .button-group {
      display: flex;
      gap: 10px;
    }

    .button-group button {
      flex: 1;
    }

    .alert {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      display: flex;
      align-items: center;
      animation: fadeIn 0.3s ease;
    }

    .alert i {
      margin-right: 10px;
      font-size: 1.2em;
    }

    .alert.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .alert.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .alert.warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
    }

    .alert.info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .card {
      background: white;
      border-radius: 8px;
      box-shadow: var(--shadow);
      padding: 20px;
      margin-bottom: 20px;
      transition: transform 0.3s ease;
    }

    .card:hover {
      transform: translateY(-2px);
    }

    .card-title {
      font-size: 1.2em;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
      color: var(--primary);
      display: flex;
      align-items: center;
    }

    .card-title i {
      margin-right: 10px;
    }

    .account-list {
      list-style: none;
    }

    .account-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 1px solid var(--border);
      border-radius: 6px;
      margin-bottom: 10px;
      transition: all 0.3s;
      background: white;
    }

    .account-item:hover {
      border-color: var(--primary);
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }

    .account-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      flex-shrink: 0;
    }

    .account-details {
      flex-grow: 1;
    }

    .account-name {
      font-weight: 500;
      margin-bottom: 3px;
    }

    .account-meta {
      font-size: 0.9em;
      color: var(--text-light);
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
    }

    .account-actions {
      display: flex;
      gap: 5px;
    }

    .project-selector {
      margin: 20px 0;
    }

    .project-item {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 10px;
      transition: all 0.2s;
    }

    .project-item:hover {
      border-color: var(--primary);
      transform: translateX(3px);
    }

    .project-item input[type="checkbox"] {
      margin-right: 10px;
    }

    .project-item label {
      flex-grow: 1;
      margin: 0;
      cursor: pointer;
    }

    .project-item input[type="number"] {
      width: 60px;
      margin-left: 10px;
    }

    .preview-section {
      margin-top: 30px;
      border-top: 1px solid var(--border);
      padding-top: 20px;
    }

    .preview-container {
      background: #2a2a2a;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
      overflow: auto;
    }

    .color-preview {
      width: 30px;
      height: 30px;
      border-radius: 4px;
      display: inline-block;
      vertical-align: middle;
      margin-left: 10px;
      border: 1px solid var(--border);
      transition: all 0.3s;
    }

    .icon-preview {
      font-size: 1.5em;
      margin-right: 10px;
      color: var(--primary);
    }

    .category-tag {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      background: var(--light-bg);
      color: var(--text-light);
    }

    .hidden {
      display: none !important;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltip-text {
      visibility: hidden;
      width: 200px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .container {
        border-radius: 0;
      }
      
      .form-row {
        flex-direction: column;
        gap: 15px;
      }
      
      .tab {
        padding: 12px 15px;
        font-size: 0.9em;
      }
      
      header {
        padding: 20px 15px;
      }
      
      header h1 {
        font-size: 1.5em;
      }
      
      .tab-content {
        padding: 15px;
      }

      .account-item {
        flex-direction: column;
        align-items: flex-start;
      }

      .account-actions {
        margin-top: 10px;
        width: 100%;
        justify-content: flex-end;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <i class="fas fa-tasks"></i>
      </div>
      <h1>MMM-StylishTodoist Setup</h1>
      <p>Configure your Todoist module for MagicMirror</p>
    </header>
    
    <div class="tabs">
      <div class="tab active" data-tab="accounts">
        <i class="fas fa-user-circle"></i> Accounts
        <span class="tab-badge" id="accounts-count">0</span>
      </div>
      <div class="tab" data-tab="projects">
        <i class="fas fa-project-diagram"></i> Projects
      </div>
      <div class="tab" data-tab="display">
        <i class="fas fa-paint-brush"></i> Display
      </div>
      <div class="tab" data-tab="advanced">
        <i class="fas fa-cog"></i> Advanced
      </div>
      <div class="tab-indicator" id="tab-indicator"></div>
    </div>
    
    <!-- Accounts Tab -->
    <div class="tab-content active" id="accounts">
      <div class="card">
        <h2 class="card-title"><i class="fas fa-user-plus"></i> Add New Account</h2>
        <div class="alert hidden" id="account-alert"></div>
        
        <div class="form-group">
          <label for="account-name">Account Name</label>
          <input type="text" id="account-name" placeholder="e.g. Personal, Work" required>
        </div>
        
        <div class="form-group">
          <label for="api-token">Todoist API Token</label>
          <div class="input-with-icon">
            <input type="password" id="api-token" placeholder="Find in Todoist Settings → Integrations" required>
            <i class="fas fa-eye" id="toggle-token-visibility"></i>
          </div>
          <small>
            <a href="https://todoist.com/app/settings/integrations" target="_blank" class="tooltip">
              Where to find my API token?
              <span class="tooltip-text">Go to Todoist Settings → Integrations → API token</span>
            </a>
          </small>
        </div>
        
        <div class="form-row">
          <div class="form-col">
            <label for="account-category">Category</label>
            <select id="account-category">
              <option value="default">Default</option>
              <option value="work">Work</option>
              <option value="personal">Personal</option>
              <option value="family">Family</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div class="form-col" id="custom-category-container" style="display: none;">
            <label for="custom-category">Custom Category Name</label>
            <input type="text" id="custom-category" placeholder="Enter category name">
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-col">
            <label for="account-icon">Icon</label>
            <select id="account-icon">
              <option value="tasks">Tasks (Default)</option>
              <option value="briefcase">Work</option>
              <option value="user">Personal</option>
              <option value="users">Family</option>
              <option value="home">Home</option>
              <option value="shopping-cart">Shopping</option>
              <option value="dumbbell">Fitness</option>
            </select>
          </div>
          <div class="form-col">
            <label for="account-color">Color</label>
            <div style="display: flex; align-items: center;">
              <input type="color" id="account-color" value="#E84C3D" style="flex: 1;">
              <span class="color-preview" id="color-preview" style="background-color: #E84C3D;"></span>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <button id="test-connection" class="secondary" style="margin-right: 10px;">
            <i class="fas fa-plug"></i> Test Connection
          </button>
          <button id="add-account" class="success">
            <i class="fas fa-plus-circle"></i> Add Account
          </button>
        </div>
      </div>
      
      <div class="card">
        <h2 class="card-title"><i class="fas fa-users"></i> Your Accounts</h2>
        <div class="alert hidden" id="accounts-list-alert"></div>
        <div class="alert info hidden" id="loading-accounts">
          <i class="fas fa-spinner fa-spin"></i> Loading accounts...
        </div>
        <ul class="account-list" id="accounts-list">
          <li class="account-empty">No accounts added yet</li>
        </ul>
      </div>
    </div>
    
    <!-- Projects Tab -->
    <div class="tab-content" id="projects">
      <div class="card">
        <h2 class="card-title"><i class="fas fa-project-diagram"></i> Project Selection</h2>
        <p>Select which projects to display and set task limits for each</p>
        
        <div class="alert hidden" id="projects-alert"></div>
        <div class="alert info hidden" id="loading-projects">
          <i class="fas fa-spinner fa-spin"></i> Loading projects...
        </div>
        
        <div class="form-group">
          <label for="project-filter">Filter Projects</label>
          <div class="input-with-icon">
            <input type="text" id="project-filter" placeholder="Search projects...">
            <i class="fas fa-search"></i>
          </div>
        </div>
        
        <div id="project-selector" class="project-selector">
          <div class="alert info">
            <i class="fas fa-info-circle"></i> Please add at least one account to see available projects
          </div>
        </div>
        
        <div class="form-group">
          <label for="default-project-limit">Default Tasks per Project</label>
          <input type="number" id="default-project-limit" min="1" max="50" value="5">
        </div>
        
        <button id="save-projects" class="hidden">
          <i class="fas fa-save"></i> Save Project Settings
        </button>
      </div>
    </div>
    
    <!-- Display Tab -->
    <div class="tab-content" id="display">
      <div class="card">
        <h2 class="card-title"><i class="fas fa-sliders-h"></i> Display Settings</h2>
        
        <div class="alert hidden" id="display-alert"></div>
        
        <div class="form-row">
          <div class="form-col">
            <label for="due-tasks-limit">Due Tasks Limit</label>
            <input type="number" id="due-tasks-limit" min="1" max="20" value="5">
          </div>
          <div class="form-col">
            <label for="theme-color">Theme Color</label>
            <div style="display: flex; align-items: center;">
              <input type="color" id="theme-color" value="#E84C3D">
              <span class="color-preview" id="theme-color-preview" style="background-color: #E84C3D;"></span>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label>Display Options</label>
          <div class="form-row">
            <div class="form-col">
              <label class="inline">
                <input type="checkbox" id="show-avatars" checked> Show Avatars
              </label>
              <label class="inline">
                <input type="checkbox" id="show-priority" checked> Show Priority
              </label>
            </div>
            <div class="form-col">
              <label class="inline">
                <input type="checkbox" id="show-dividers" checked> Show Dividers
              </label>
              <label class="inline">
                <input type="checkbox" id="show-project-headers" checked> Show Project Headers
              </label>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label for="date-format">Date Format</label>
          <select id="date-format">
            <option value="DD.MM.YYYY">DD.MM.YYYY (European)</option>
            <option value="MM/DD/YYYY">MM/DD/YYYY (US)</option>
            <option value="YYYY-MM-DD">YYYY-MM-DD (ISO)</option>
            <option value="relative">Relative (Today, Tomorrow)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="group-by">Group Tasks By</label>
          <select id="group-by">
            <option value="project">Project</option>
            <option value="date">Due Date</option>
            <option value="priority">Priority</option>
            <option value="none">No Grouping</option>
          </select>
        </div>
        
        <button id="save-display" class="success">
          <i class="fas fa-save"></i> Save Display Settings
        </button>
      </div>
      
      <div class="preview-section">
        <h2 class="card-title"><i class="fas fa-eye"></i> Live Preview</h2>
        <p>See how your changes will look on the mirror</p>
        <div class="preview-container" id="live-preview">
          <!-- Preview will be rendered here -->
        </div>
      </div>
    </div>
    
    <!-- Advanced Tab -->
    <div class="tab-content" id="advanced">
      <div class="card">
        <h2 class="card-title"><i class="fas fa-cogs"></i> Advanced Settings</h2>
        
        <div class="alert hidden" id="advanced-alert"></div>
        
        <div class="form-group">
          <label for="update-interval">Update Interval (minutes)</label>
          <input type="number" id="update-interval" min="1" max="1440" value="10">
        </div>
        
        <div class="form-group">
          <label for="api-version">API Version</label>
          <select id="api-version">
            <option value="v2">v2 (Recommended)</option>
            <option value="v1">v1 (Legacy)</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="fade-speed">Fade Animation Speed (ms)</label>
          <input type="number" id="fade-speed" min="0" max="10000" value="3000">
        </div>
        
        <div class="form-group">
          <label for="maximum-entries">Maximum Tasks</label>
          <input type="number" id="maximum-entries" min="1" max="200" value="30">
        </div>
        
        <button id="save-advanced" class="success">
          <i class="fas fa-save"></i> Save Advanced Settings
        </button>
      </div>
      
      <div class="card">
        <h2 class="card-title"><i class="fas fa-tools"></i> Module Management</h2>
        
        <div class="form-group">
          <label>Cache Management</label>
          <div class="button-group">
            <button id="clear-cache" class="secondary">
              <i class="fas fa-trash-alt"></i> Clear Cache
            </button>
            <button id="refresh-data" class="secondary">
              <i class="fas fa-sync-alt"></i> Refresh Now
            </button>
          </div>
        </div>
        
        <div class="form-group">
          <label>Configuration</label>
          <div class="button-group">
            <button id="export-config" class="secondary">
              <i class="fas fa-file-export"></i> Export Config
            </button>
            <button id="import-config" class="secondary">
              <i class="fas fa-file-import"></i> Import Config
            </button>
          </div>
        </div>
        
        <div class="form-group">
          <label>Reset Settings</label>
          <button id="reset-settings" class="danger">
            <i class="fas fa-exclamation-triangle"></i> Reset to Defaults
          </button>
          <small>Warning: This will erase all your settings</small>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global state
    const state = {
      accounts: [],
      projects: [],
      settings: {},
      currentTab: 'accounts'
    };

    document.addEventListener('DOMContentLoaded', function() {
      // Initialize tab indicator
      const tabIndicator = document.getElementById('tab-indicator');
      const activeTab = document.querySelector('.tab.active');
      if (activeTab) {
        tabIndicator.style.width = `${activeTab.offsetWidth}px`;
        tabIndicator.style.left = `${activeTab.offsetLeft}px`;
      }

      // Tab switching with animation
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          if (state.currentTab === tabName) return;
          
          state.currentTab = tabName;
          
          // Update active tab
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          this.classList.add('active');
          document.getElementById(tabName).classList.add('active');
          
          // Animate tab indicator
          tabIndicator.style.width = `${this.offsetWidth}px`;
          tabIndicator.style.left = `${this.offsetLeft}px`;
          
          // Load data for the tab if needed
          if (tabName === 'projects' && state.projects.length === 0) {
            loadProjects();
          }
        });
      });
      
      // Category selection
      document.getElementById('account-category').addEventListener('change', function() {
        document.getElementById('custom-category-container').style.display = 
          this.value === 'custom' ? 'block' : 'none';
      });
      
      // Color previews
      document.getElementById('account-color').addEventListener('input', function() {
        document.getElementById('color-preview').style.backgroundColor = this.value;
      });
      
      document.getElementById('theme-color').addEventListener('input', function() {
        document.getElementById('theme-color-preview').style.backgroundColor = this.value;
        updatePreview();
      });
      
      // Toggle token visibility
      document.getElementById('toggle-token-visibility').addEventListener('click', function() {
        const tokenInput = document.getElementById('api-token');
        if (tokenInput.type === 'password') {
          tokenInput.type = 'text';
          this.classList.replace('fa-eye', 'fa-eye-slash');
        } else {
          tokenInput.type = 'password';
          this.classList.replace('fa-eye-slash', 'fa-eye');
        }
      });
      
      // Test connection button
      document.getElementById('test-connection').addEventListener('click', testConnection);
      
      // Load initial data
      loadAccounts();
      loadDisplaySettings();
      loadAdvancedSettings();
      updatePreview();
      
      // Event listeners
      document.getElementById('add-account').addEventListener('click', addAccount);
      document.getElementById('save-projects').addEventListener('click', saveProjectSettings);
      document.getElementById('save-display').addEventListener('click', saveDisplaySettings);
      document.getElementById('save-advanced').addEventListener('click', saveAdvancedSettings);
      document.getElementById('clear-cache').addEventListener('click', clearCache);
      document.getElementById('refresh-data').addEventListener('click', refreshData);
      document.getElementById('export-config').addEventListener('click', exportConfig);
      document.getElementById('import-config').addEventListener('click', importConfig);
      document.getElementById('reset-settings').addEventListener('click', resetSettings);
      
      // Live preview updates
      const previewElements = [
        ...document.querySelectorAll('#display input'),
        ...document.querySelectorAll('#display select'),
        ...document.querySelectorAll('#display input[type="checkbox"]')
      ];
      
      previewElements.forEach(el => {
        el.addEventListener('change', updatePreview);
      });
    });
    
    function showAlert(elementId, message, type = 'info', duration = 5000) {
      const alert = document.getElementById(elementId);
      const iconMap = {
        success: 'check-circle',
        error: 'exclamation-circle',
        warning: 'exclamation-triangle',
        info: 'info-circle'
      };
      
      alert.innerHTML = `<i class="fas fa-${iconMap[type] || 'info-circle'}"></i> ${message}`;
      alert.className = `alert ${type}`;
      alert.style.display = 'flex';
      
      if (duration > 0) {
        setTimeout(() => {
          alert.className = 'alert hidden';
        }, duration);
      }
    }
    
    function showLoading(elementId, show) {
      const element = document.getElementById(elementId);
      if (show) {
        element.classList.remove('hidden');
      } else {
        element.classList.add('hidden');
      }
    }
    
    async function loadAccounts() {
      showLoading('loading-accounts', true);
      
      try {
        const response = await fetch('/MMM-StylishTodoist/api/accounts/default');
        if (!response.ok) throw new Error('Failed to load accounts');
        
        const data = await response.json();
        if (data.success) {
          state.accounts = data.data || [];
          updateAccountsList(state.accounts);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        showAlert('accounts-list-alert', `Error loading accounts: ${error.message}`, 'error');
        console.error('Error loading accounts:', error);
      } finally {
        showLoading('loading-accounts', false);
      }
    }
    
    function updateAccountsList(accounts) {
      const list = document.getElementById('accounts-list');
      const count = document.getElementById('accounts-count');
      
      if (accounts.length === 0) {
        list.innerHTML = '<li class="account-empty">No accounts added yet</li>';
        count.textContent = '0';
        return;
      }
      
      list.innerHTML = '';
      accounts.forEach(account => {
        const item = document.createElement('li');
        item.className = 'account-item';
        item.innerHTML = `
          <div class="account-icon" style="background-color: ${account.color}">
            <i class="fas fa-${account.icon || 'user'}"></i>
          </div>
          <div class="account-details">
            <div class="account-name">${account.name}</div>
            <div class="account-meta">
              <span class="category-tag">${account.category}</span>
              ${account.lastSynced ? `Last synced: ${new Date(account.lastSynced).toLocaleString()}` : 'Not synced yet'}
            </div>
          </div>
          <div class="account-actions">
            <button class="secondary" onclick="editAccount('${account.token}')">
              <i class="fas fa-edit"></i> Edit
            </button>
            <button class="danger" onclick="deleteAccount('${account.token}')">
              <i class="fas fa-trash-alt"></i> Delete
            </button>
          </div>
        `;
        list.appendChild(item);
      });
      
      count.textContent = accounts.length;
    }
    
    async function testConnection() {
      const token = document.getElementById('api-token').value;
      if (!token) {
        showAlert('account-alert', 'Please enter an API token first', 'error');
        return;
      }
      
      const testBtn = document.getElementById('test-connection');
      testBtn.disabled = true;
      testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
      
      try {
        const response = await fetch('/MMM-StylishTodoist/api/test-connection', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ token })
        });
        
        const data = await response.json();
        if (data.success) {
          showAlert('account-alert', 'Connection successful! Token is valid', 'success');
        } else {
          throw new Error(data.error || 'Connection failed');
        }
      } catch (error) {
        showAlert('account-alert', `Connection failed: ${error.message}`, 'error');
        console.error('Connection test failed:', error);
      } finally {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="fas fa-plug"></i> Test Connection';
      }
    }
    
    async function addAccount() {
      const name = document.getElementById('account-name').value.trim();
      const token = document.getElementById('api-token').value.trim();
      const category = document.getElementById('account-category').value;
      const customCategory = document.getElementById('custom-category').value.trim();
      const icon = document.getElementById('account-icon').value;
      const color = document.getElementById('account-color').value;
      
      if (!name || !token) {
        showAlert('account-alert', 'Please fill in all required fields', 'error');
        return;
      }
      
      const finalCategory = category === 'custom' ? customCategory : category;
      if (category === 'custom' && !finalCategory) {
        showAlert('account-alert', 'Please enter a custom category name', 'error');
        return;
      }
      
      // Verify token is valid first
      const testBtn = document.getElementById('test-connection');
      testBtn.disabled = true;
      testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
      
      try {
        // First test connection
        const testResponse = await fetch('/MMM-StylishTodoist/api/test-connection', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ token })
        });
        
        const testData = await testResponse.json();
        if (!testData.success || !testData.valid) {
          showAlert('account-alert', 'Invalid API token. Please check your token and try again.', 'error');
          return;
        }
        
        // Now add account
        const accountData = {
          name,
          token,
          category: finalCategory,
          icon,
          color
        };
        
        const addBtn = document.getElementById('add-account');
        addBtn.disabled = true;
        addBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        
        try {
          const response = await fetch('/MMM-StylishTodoist/api/accounts/default', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(accountData)
          });
          
          const data = await response.json();
          if (data.success) {
            showAlert('account-alert', 'Account added successfully!', 'success');
            // Reset form
            document.getElementById('account-name').value = '';
            document.getElementById('api-token').value = '';
            document.getElementById('custom-category').value = '';
            document.getElementById('account-category').value = 'default';
            document.getElementById('custom-category-container').style.display = 'none';
            
            // Reload accounts
            await loadAccounts();
          } else {
            throw new Error(data.error || 'Failed to add account');
          }
        } catch (error) {
          showAlert('account-alert', `Error adding account: ${error.message}`, 'error');
          console.error('Error adding account:', error);
        } finally {
          addBtn.disabled = false;
          addBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Add Account';
        }
      } catch (error) {
        showAlert('account-alert', `Connection failed: ${error.message}`, 'error');
        console.error('Connection test failed:', error);
      } finally {
        testBtn.disabled = false;
        testBtn.innerHTML = '<i class="fas fa-plug"></i> Test Connection';
      }
    }
    
    async function editAccount(token) {
      // Find the account in state
      const account = state.accounts.find(acc => acc.token === token);
      if (!account) {
        showAlert('accounts-list-alert', 'Account not found', 'error');
        return;
      }
      
      // Populate form
      document.getElementById('account-name').value = account.name;
      document.getElementById('api-token').value = account.token;
      
      if (['work', 'personal', 'family', 'default'].includes(account.category)) {
        document.getElementById('account-category').value = account.category;
        document.getElementById('custom-category-container').style.display = 'none';
      } else {
        document.getElementById('account-category').value = 'custom';
        document.getElementById('custom-category').value = account.category;
        document.getElementById('custom-category-container').style.display = 'block';
      }
      
      document.getElementById('account-icon').value = account.icon || 'tasks';
      document.getElementById('account-color').value = account.color || '#E84C3D';
      document.getElementById('color-preview').style.backgroundColor = account.color || '#E84C3D';
      
      // Scroll to form
      document.getElementById('account-name').focus();
      document.querySelector('.tab-content.active').scrollTo({
        top: 0,
        behavior: 'smooth'
      });
      
      showAlert('account-alert', `Editing account: ${account.name}`, 'info', 0);
    }
    
    async function deleteAccount(token) {
      if (!confirm('Are you sure you want to delete this account? This action cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch(`/MMM-StylishTodoist/api/accounts/default/${encodeURIComponent(token)}`, {
          method: 'DELETE'
        });
        
        const data = await response.json();
        if (data.success) {
          showAlert('accounts-list-alert', 'Account deleted successfully', 'success');
          await loadAccounts();
        } else {
          throw new Error(data.error || 'Failed to delete account');
        }
      } catch (error) {
        showAlert('accounts-list-alert', `Error deleting account: ${error.message}`, 'error');
        console.error('Error deleting account:', error);
      }
    }
    
    async function loadProjects() {
      showLoading('loading-projects', true);
      document.getElementById('project-selector').classList.add('hidden');
      
      try {
        const response = await fetch('/MMM-StylishTodoist/api/projects/default');
        if (!response.ok) throw new Error('Failed to load projects');
        
        const data = await response.json();
        if (data.success) {
          state.projects = data.data || [];
          updateProjectList(state.projects);
          document.getElementById('save-projects').classList.remove('hidden');
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        showAlert('projects-alert', `Error loading projects: ${error.message}`, 'error');
        console.error('Error loading projects:', error);
      } finally {
        showLoading('loading-projects', false);
      }
    }
    
    function updateProjectList(projects) {
      const container = document.getElementById('project-selector');
      container.innerHTML = '';
      
      if (projects.length === 0) {
        container.innerHTML = `
          <div class="alert info">
            <i class="fas fa-info-circle"></i> No projects found in your Todoist account
          </div>
        `;
        return;
      }
      
      const filterInput = document.getElementById('project-filter').value.toLowerCase();
      
      projects.forEach(project => {
        if (filterInput && !project.name.toLowerCase().includes(filterInput)) {
          return;
        }
        
        const projectItem = document.createElement('div');
        projectItem.className = 'project-item';
        projectItem.innerHTML = `
          <input type="checkbox" id="project-${project.id}" ${state.settings.selectedProjects?.includes(project.id) ? 'checked' : ''}>
          <label for="project-${project.id}">${project.name}</label>
          <input type="number" id="limit-${project.id}" min="1" max="20" 
                 value="${state.settings.projectLimits?.[project.id] || document.getElementById('default-project-limit').value || 5}">
        `;
        container.appendChild(projectItem);
      });
      
      container.classList.remove('hidden');
    }
    
    async function saveProjectSettings() {
      const projects = state.projects;
      const selectedProjects = [];
      const projectLimits = {};
      const defaultLimit = parseInt(document.getElementById('default-project-limit').value) || 5;
      
      projects.forEach(project => {
        const checkbox = document.getElementById(`project-${project.id}`);
        if (checkbox?.checked) {
          selectedProjects.push(project.id);
          
          const limitInput = document.getElementById(`limit-${project.id}`);
          const limit = limitInput ? parseInt(limitInput.value) : defaultLimit;
          projectLimits[project.id] = limit;
        }
      });
      
      const saveBtn = document.getElementById('save-projects');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
      
      try {
        const response = await fetch('/MMM-StylishTodoist/api/projects/default', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            selectedProjects,
            projectLimits
          })
        });
        
        const data = await response.json();
        if (data.success) {
          showAlert('projects-alert', 'Project settings saved successfully!', 'success');
          state.settings.selectedProjects = selectedProjects;
          state.settings.projectLimits = projectLimits;
        } else {
          throw new Error(data.error || 'Failed to save project settings');
        }
      } catch (error) {
        showAlert('projects-alert', `Error saving project settings: ${error.message}`, 'error');
        console.error('Error saving project settings:', error);
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Project Settings';
      }
    }
    
    async function loadDisplaySettings() {
      try {
        const response = await fetch('/MMM-StylishTodoist/api/display/default');
        if (!response.ok) throw new Error('Failed to load display settings');
        
        const data = await response.json();
        if (data.success) {
          state.settings = { ...state.settings, ...data.data };
          applyDisplaySettings(data.data);
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Error loading display settings:', error);
      }
    }
    
    function applyDisplaySettings(settings) {
      if (!settings) return;
      
      if (settings.dueTasksLimit) {
        document.getElementById('due-tasks-limit').value = settings.dueTasksLimit;
      }
      
      if (settings.themeColor) {
        document.getElementById('theme-color').value = settings.themeColor;
        document.getElementById('theme-color-preview').style.backgroundColor = settings.themeColor;
      }
      
      if (settings.showAvatars !== undefined) {
        document.getElementById('show-avatars').checked = settings.showAvatars;
      }
      
      if (settings.showPriority !== undefined) {
        document.getElementById('show-priority').checked = settings.showPriority;
      }
      
      if (settings.showDividers !== undefined) {
        document.getElementById('show-dividers').checked = settings.showDividers;
      }
      
      if (settings.showProjectHeaders !== undefined) {
        document.getElementById('show-project-headers').checked = settings.showProjectHeaders;
      }
      
      if (settings.dateFormat) {
        document.getElementById('date-format').value = settings.dateFormat;
      }
      
      if (settings.groupBy) {
        document.getElementById('group-by').value = settings.groupBy;
      }
    }
    
    async function saveDisplaySettings() {
      const settings = {
        dueTasksLimit: parseInt(document.getElementById('due-tasks-limit').value) || 5,
        themeColor: document.getElementById('theme-color').value,
        showAvatars: document.getElementById('show-avatars').checked,
        showPriority: document.getElementById('show-priority').checked,
        showDividers: document.getElementById('show-dividers').checked,
        showProjectHeaders: document.getElementById('show-project-headers').checked,
        dateFormat: document.getElementById('date-format').value,
        groupBy: document.getElementById('group-by').value
      };
      
      const saveBtn = document.getElementById('save-display');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
      
      try {
        const response = await fetch('/MMM-StylishTodoist/api/settings/default', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(settings)
        });
        
        const data = await response.json();
        if (data.success) {
          showAlert('display-alert', 'Display settings saved successfully!', 'success');
          state.settings = { ...state.settings, ...settings };
          updatePreview();
        } else {
          throw new Error(data.error || 'Failed to save display settings');
        }
      } catch (error) {
        showAlert('display-alert', `Error saving display settings: ${error.message}`, 'error');
        console.error('Error saving display settings:', error);
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Display Settings';
      }
    }
    
    async function loadAdvancedSettings() {
      try {
        const response = await fetch('/MMM-StylishTodoist/api/settings/default');
        if (!response.ok) throw new Error('Failed to load advanced settings');
        
        const data = await response.json();
        if (data.success) {
          if (data.settings.updateInterval) {
            document.getElementById('update-interval').value = data.settings.updateInterval;
          }
          
          if (data.settings.apiVersion) {
            document.getElementById('api-version').value = data.settings.apiVersion;
          }
          
          if (data.settings.fadeSpeed) {
            document.getElementById('fade-speed').value = data.settings.fadeSpeed;
          }
          
          if (data.settings.maximumEntries) {
            document.getElementById('maximum-entries').value = data.settings.maximumEntries;
          }
        } else {
          throw new Error(data.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Error loading advanced settings:', error);
      }
    }
    
    async function saveAdvancedSettings() {
      const settings = {
        updateInterval: parseInt(document.getElementById('update-interval').value) || 10,
        apiVersion: document.getElementById('api-version').value,
        fadeSpeed: parseInt(document.getElementById('fade-speed').value) || 3000,
        maximumEntries: parseInt(document.getElementById('maximum-entries').value) || 30
      };
      
      const saveBtn = document.getElementById('save-advanced');
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
      
      try {
        const response = await fetch('/MMM-StylishTodoist/api/settings/default', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(settings)
        });
        
        const data = await response.json();
        if (data.success) {
          showAlert('advanced-alert', 'Advanced settings saved successfully!', 'success');
          state.settings = { ...state.settings, ...settings };
        } else {
          throw new Error(data.error || 'Failed to save advanced settings');
        }
      } catch (error) {
        showAlert('advanced-alert', `Error saving advanced settings: ${error.message}`, 'error');
        console.error('Error saving advanced settings:', error);
      } finally {
        saveBtn.disabled = false;
        saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Advanced Settings';
      }
    }
    
    async function clearCache() {
      if (!confirm('Are you sure you want to clear the cache? This will force a fresh data load on next refresh.')) {
        return;
      }
      
      const clearBtn = document.getElementById('clear-cache');
      clearBtn.disabled = true;
      clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Clearing...';
      
      try {
        const response = await fetch('/MMM-StylishTodoist/api/clear-cache', {
          method: 'POST'
        });
        
        const data = await response.json();
        if (data.success) {
          showAlert('advanced-alert', 'Cache cleared successfully!', 'success');
        } else {
          throw new Error(data.error || 'Failed to clear cache');
        }
      } catch (error) {
        showAlert('advanced-alert', `Error clearing cache: ${error.message}`, 'error');
        console.error('Error clearing cache:', error);
      } finally {
        clearBtn.disabled = false;
        clearBtn.innerHTML = '<i class="fas fa-trash-alt"></i> Clear Cache';
      }
    }
    
    async function refreshData() {
      const refreshBtn = document.getElementById('refresh-data');
      refreshBtn.disabled = true;
      refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
      
      try {
        const response = await fetch('/MMM-StylishTodoist/api/refresh/default', {
          method: 'POST'
        });
        
        const data = await response.json();
        if (data.success) {
          showAlert('advanced-alert', 'Data refresh initiated!', 'success');
        } else {
          throw new Error(data.error || 'Failed to refresh data');
        }
      } catch (error) {
        showAlert('advanced-alert', `Error refreshing data: ${error.message}`, 'error');
        console.error('Error refreshing data:', error);
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh Now';
      }
    }
    
    async function exportConfig() {
      try {
        const response = await fetch('/MMM-StylishTodoist/api/export/default');
        if (!response.ok) throw new Error('Failed to export config');
        
        const data = await response.json();
        if (data.success) {
          // Create a download link
          const blob = new Blob([JSON.stringify(data.data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `MMM-StylishTodoist-config-${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          showAlert('advanced-alert', 'Configuration exported successfully!', 'success');
        } else {
          throw new Error(data.error || 'Failed to export config');
        }
      } catch (error) {
        showAlert('advanced-alert', `Error exporting config: ${error.message}`, 'error');
        console.error('Error exporting config:', error);
      }
    }
    
    async function importConfig() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = async e => {
        const file = e.target.files[0];
        if (!file) return;
        
        const importBtn = document.getElementById('import-config');
        importBtn.disabled = true;
        importBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Importing...';
        
        try {
          const fileContent = await file.text();
          const config = JSON.parse(fileContent);
          
          const response = await fetch('/MMM-StylishTodoist/api/import/default', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: fileContent
          });
          
          const data = await response.json();
          if (data.success) {
            showAlert('advanced-alert', 'Configuration imported successfully!', 'success');
            // Reload all settings
            await Promise.all([
              loadAccounts(),
              loadProjects(),
              loadDisplaySettings(),
              loadAdvancedSettings()
            ]);
          } else {
            throw new Error(data.error || 'Failed to import config');
          }
        } catch (error) {
          showAlert('advanced-alert', `Error importing config: ${error.message}`, 'error');
          console.error('Error importing config:', error);
        } finally {
          importBtn.disabled = false;
          importBtn.innerHTML = '<i class="fas fa-file-import"></i> Import Config';
        }
      };
      
      input.click();
    }
    
    async function resetSettings() {
      if (!confirm('Are you sure you want to reset all settings to defaults? This action cannot be undone.')) {
        return;
      }
      
      const resetBtn = document.getElementById('reset-settings');
      resetBtn.disabled = true;
      resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetting...';
      
      try {
        const response = await fetch('/MMM-StylishTodoist/api/reset/default', {
          method: 'POST'
        });
        
        const data = await response.json();
        if (data.success) {
          showAlert('advanced-alert', 'Settings reset to defaults!', 'success');
          // Reload all settings
          await Promise.all([
            loadAccounts(),
            loadProjects(),
            loadDisplaySettings(),
            loadAdvancedSettings()
          ]);
        } else {
          throw new Error(data.error || 'Failed to reset settings');
        }
      } catch (error) {
        showAlert('advanced-alert', `Error resetting settings: ${error.message}`, 'error');
        console.error('Error resetting settings:', error);
      } finally {
        resetBtn.disabled = false;
        resetBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Reset to Defaults';
      }
    }
    
    function updatePreview() {
      const preview = document.getElementById('live-preview');
      const dueLimit = document.getElementById('due-tasks-limit').value;
      const themeColor = document.getElementById('theme-color').value;
      const showAvatars = document.getElementById('show-avatars').checked;
      const showPriority = document.getElementById('show-priority').checked;
      const showDividers = document.getElementById('show-dividers').checked;
      const showProjectHeaders = document.getElementById('show-project-headers').checked;
      const dateFormat = document.getElementById('date-format').value;
      const groupBy = document.getElementById('group-by').value;
      
      // Generate sample tasks based on settings
      const sampleTasks = generateSampleTasks(
        dueLimit, 
        themeColor, 
        showAvatars, 
        showPriority,
        groupBy
      );
      
      preview.innerHTML = `
        <div style="color: white; font-family: 'Roboto', sans-serif; max-width: 500px; margin: 0 auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
            <div style="display: flex; align-items: center; font-size: 1.2em; font-weight: 500; color: ${themeColor};">
              <i class="fas fa-tasks" style="margin-right: 10px;"></i>
              <span>Todoist Tasks</span>
            </div>
            <div style="font-size: 0.8em; color: rgba(255, 255, 255, 0.6);">
              ${new Date().toLocaleTimeString()}
            </div>
          </div>
          
          ${sampleTasks}
        </div>
      `;
    }
    
    function generateSampleTasks(dueLimit, themeColor, showAvatars, showPriority, groupBy) {
      const now = new Date();
      const sampleTasks = [];
      
      // Generate due tasks
      for (let i = 0; i < dueLimit; i++) {
        const isOverdue = i === 0;
        const isToday = i === 1;
        const isTomorrow = i === 2;
        
        let dueDate;
        let dueText;
        
        if (isOverdue) {
          dueDate = new Date(now);
          dueDate.setDate(dueDate.getDate() - 1);
          dueText = 'Overdue';
        } else if (isToday) {
          dueDate = new Date(now);
          dueText = 'Today';
        } else if (isTomorrow) {
          dueDate = new Date(now);
          dueDate.setDate(dueDate.getDate() + 1);
          dueText = 'Tomorrow';
        } else {
          dueDate = new Date(now);
          dueDate.setDate(dueDate.getDate() + i);
          dueText = dueDate.toLocaleDateString();
        }
        
        sampleTasks.push(`
          <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255, 255, 255, 0.08); border-radius: 6px; position: relative; ${isOverdue ? 'border-left: 3px solid #ff5252;' : ''}">
            ${showAvatars ? `<img src="https://i.pravatar.cc/40?img=${i+1}" style="width: 28px; height: 28px; border-radius: 50%; border: 2px solid ${themeColor}; flex-shrink: 0; object-fit: cover;">` : ''}
            <div style="flex-grow: 1; min-width: 0; display: flex; align-items: center; gap: 8px;">
              ${showPriority && isOverdue ? `<div style="color: ${themeColor}; font-size: 0.9em; flex-shrink: 0;"><i class="fas fa-exclamation-circle"></i></div>` : ''}
              <div style="flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95em;">
                ${isOverdue ? 'Urgent task that needs attention' : `Task ${i+1} with due date`}
              </div>
              <div style="font-size: 0.8em; color: ${isOverdue ? '#ff5252' : 'rgba(255, 255, 255, 0.7)'}; flex-shrink: 0; padding-left: 10px; font-weight: ${isOverdue ? '500' : 'normal'}">
                ${dueText}
              </div>
            </div>
          </div>
        `);
      }
      
      // Generate project tasks if grouped by project
      if (groupBy === 'project') {
        const projectTasks = [];
        
        for (let i = 0; i < 2; i++) {
          const projectName = i === 0 ? 'Work' : 'Personal';
          const projectColor = i === 0 ? '#3498db' : '#2ecc71';
          
          let projectSection = '';
          
          // Fixed showProjectHeaders variable
          const showProjectHeaders = document.getElementById("showDividers")?.checked || true;
          
          if (showProjectHeaders) {
            projectSection += `
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div style="font-weight: 500; font-size: 1.05em; color: ${projectColor}">${projectName}</div>
                <div style="font-size: 0.85em; color: rgba(255, 255, 255, 0.6); background: rgba(255, 255, 255, 0.1); padding: 2px 8px; border-radius: 10px;">3 tasks</div>
              </div>
            `;
          }
          
          if (showDividers) {
            projectSection += `
              <div style="height: 1px; background: linear-gradient(to right, transparent, ${projectColor}, transparent); margin: 8px 0 12px; opacity: 0.3;"></div>
            `;
          }
          
          projectSection += `
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${Array.from({length: 3}, (_, j) => `
                <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(255, 255, 255, 0.08); border-radius: 6px;">
                  ${showAvatars ? `<img src="https://i.pravatar.cc/40?img=${i*3 + j + 4}" style="width: 28px; height: 28px; border-radius: 50%; border: 2px solid ${projectColor}; flex-shrink: 0; object-fit: cover;">` : ''}
                  <div style="flex-grow: 1; min-width: 0; display: flex; align-items: center; gap: 8px;">
                    <div style="flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95em;">
                      ${projectName} task ${j+1}
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          `;
          
          projectTasks.push(`
            <div style="margin-top: 20px;">
              ${projectSection}
            </div>
          `);
        }
        
        return `
          <div style="display: flex; flex-direction: column; gap: 20px;">
            <div style="background: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 12px;">
              <div style="font-size: 1.1em; font-weight: 500; margin-bottom: 12px; color: ${themeColor}; display: flex; align-items: center;">
                <span style="display: inline-block; width: 4px; height: 16px; background: ${themeColor}; margin-right: 8px; border-radius: 2px;"></span>
                Due Tasks
              </div>
              
              <div style="display: flex; flex-direction: column; gap: 8px;">
                ${sampleTasks.join('')}
              </div>
            </div>
            
            ${projectTasks.join('')}
          </div>
        `;
      }
      
      // Default list view
      return `
        <div style="display: flex; flex-direction: column; gap: 8px;">
          ${sampleTasks.join('')}
        </div>
      `;
    }
  </script>
</body>
</html>